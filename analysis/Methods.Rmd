---
title: "Methods"
author: "Katharina Mikulik"
output: html_document
---



### Quality Control

For Quality Control I used the publications from which the datasets were obtained
as an orientation, in order to be able to reproduce the results and findings.

### Normalization

Log normalization was used to normalize count matrices, using the function `NormalizeData()`from the Seurat package. The counts of a particular
features for a particular cell are divided by the total counts for that cell and
multiplied by a scaling factor of 10,000. Then the result is natural-log 
transformed. 

For GRN inference with SCENIC the function `SCTransform()` from the Seurat 
package was used, so that the data structure would work with the SCENIC pipeline.
This method uses regularized negative binomial regression to normalize the
count matrix. 

### Clustering

After calculating a PCA the cells were clustered based on their nearest neighbors.
For clustering the functions `FindNeigbors()` and `FindClusters()` from the 
Seurat package were used. First, a k nearest neighbor (KNN) graph is built
based on the PCA space. Then, the Louvian algorithm is used, which iteratively 
optimizes the standard modularity function. Modularity measures the strength of division 
of a network into modules. High modularity is equivalent to dense connections 
within modules and sparse connections between nodes in different modules. 

  
## Integration & Label Transfer

See here for more details on the method and implementation:
[@Stuart]

See here for a vignette:
https://satijalab.org/seurat/articles/integration_mapping.html

### Integration

First, canonical correlation analysis is performed to reduce dimensionality of both
datasets. This method can find shared biological markers, even if batch effects 
are very large. Second, expression data is L2 normalized. After the 
projection of distinct datasets into a shared subspace, pairs of MNN in this shared subspace are identified. These MNN correspond to cells which are biologically
similar. The MNN serve as integration anchors for the integration, but 
beforehand the anchors are scored. The score is a measure of how similar the two 
anchor cells are. Using anchors and their corresponding scores 
correction vectors are computed for each cell. The correction vectors contain 
information on the difference between two anchor cells. Using the correction vectors 
the expression values of each cell are transformed, so that they are part of an
integrated dataset. [@Stuart] This integrated dataset can then be used for 
further analysis.

Finding anchors between datasets is not only required for integration of two 
distinct datasets, but also for label transfer. 

### Label Transfer

After finding anchors between distinct datasets as described above, it 
is also possible to transfer information on cell type annotations. This means 
that instead of de-nove analysis of cell type markers the cell labels are learned 
from a reference dataset. Instead of using canonical correlation analysis, the
PCA computed for the reference dataset is projected onto the query dataset. 
A binary classification matrix is build with rows corresponding to all possible 
classes and columns corresponding to reference anchors of the anchor pairs. 
If a reference anchor belongs to a certain class the entry will be one, otherwise
it will be zero. The classification matrix is then multiplied with a weight matrix.
This way we get prediction scores for each class and cell in the query dataset.
[@Stuart]

* correlation  
  
  + test for correlation
  + Pearson vs Spearman?
  
## AddModuleScore

The average relative expression of genes  which 

The quality of each cell`s counts might have an effect on the gene signature score, 
therefore control genes are defined. The average relative expression of the 
control genes were defined as the control scores and are are subtracted from the
signature scores of each cell. Control genes are defined by creating bins and 
putting all analyzed genes in their respective bins depending on the expression 
levels. For each signature gene,  100 genes are drawn from the same expression
bin. The resulting 

* hierarchical clustering 
  + wss plot
  
* test for differential TF activity
  + Kruskal-Wallis
  + pairwise wilcox